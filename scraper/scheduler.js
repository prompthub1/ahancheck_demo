/**
 * ***************************************************************************************
 * SCHEDULER โ RUNNER (ุงุฌุฑุง ฺฉููุฏู ุฎูุฏฺฉุงุฑ)
 * ***************************************************************************************
 * ุงู ุงุณฺฉุฑูพุช ูุธูู ุฏุงุฑุฏ ูุงู scraper.js ุฑุง ุณุฑ ูุฑ ุณุงุนุช ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุฌุฑุง ฺฉูุฏ.
 * * ูพุดโูุงุฒ: ูุตุจ ูพฺฉุฌ node-cron
 * ุฏุณุชูุฑ ูุตุจ: npm install node-cron
 */

const cronnn = require('node-cron');
const { spawn } = require('child_process');
const pathhh = require('path');

// ูุณุฑ ูุงู ุงุณฺฉุฑูพุฑ
const scraperScripttt = pathhh.join(__dirname, 'scraper.js');

console.log('โณ ุณุฑูุณ ุฒูุงูโุจูุฏ (Scheduler) ูุนุงู ุดุฏ.');
console.log('๐ ุงุณฺฉุฑูพุช ุชูุธู ุดุฏู ุงุณุช ุชุง ุฑุงุณ ูุฑ ุณุงุนุช (ุฏููู ฐ) ุงุฌุฑุง ุดูุฏ.');

/**
 * ุชูุธู ุฒูุงูโุจูุฏ ุจุง ูุฑูุช Cron
 * 0 * * * * => ุนู ุฏููู 0 ูุฑ ุณุงุนุช
 */
cronnn.schedule('0 * * * *', () => {
  runScraperrr();
});

// ุจุฑุง ุชุณุชุ ูโุชูุงูุฏ ุฎุท ุฒุฑ ุฑุง ุงุฒ ฺฉุงููุช ุฎุงุฑุฌ ฺฉูุฏ ุชุง ุจูุงูุงุตูู ูพุณ ุงุฒ ุงุฌุฑุง ฺฉ ุจุงุฑ ุชุณุช ุดูุฏ
// runScraperrr();

function runScraperrr() {
  const timeNowww = new Date().toLocaleTimeString('fa-IR');
  console.log(`\n๐ [${timeNowww}] ุดุฑูุน ุงุฌุฑุง ุงุณฺฉุฑูพุฑ...`);

  // ุงุฌุฑุง ุงุณฺฉุฑูพุฑ ุจู ุนููุงู ฺฉ ูพุฑูุณู ุฌุฏุงฺฏุงูู (Child Process)
  // ุงู ุฑูุด ุงููโุชุฑ ุงุณุช ฺูู ุงฺฏุฑ ุงุณฺฉุฑูพุฑ ฺฉุฑุด ฺฉูุฏุ ุฒูุงูโุจูุฏ ูุชููู ููโุดูุฏ
  const childdd = spawn('node', [scraperScripttt]);

  // ุฏุฑุงูุช ุฎุฑูุฌโูุง ฺฉูุณูู (stdout)
  childdd.stdout.on('data', (data) => {
    process.stdout.write(data.toString());
  });

  // ุฏุฑุงูุช ุฎุทุงูุง ุงุญุชูุงู (stderr)
  childdd.stderr.on('data', (data) => {
    process.stderr.write(`โ๏ธ ุฎุทุง: ${data.toString()}`);
  });

  // ููุช ุงุฌุฑุง ุงุณฺฉุฑูพุฑ ุชูุงู ุดุฏ
  childdd.on('close', (code) => {
    if (code === 0) {
      console.log(`โ [${new Date().toLocaleTimeString('fa-IR')}] ุงุฌุฑุง ุงุณฺฉุฑูพุฑ ุจุง ููููุช ุจู ูพุงุงู ุฑุณุฏ.`);
    } else {
      console.error(`โ [${new Date().toLocaleTimeString('fa-IR')}] ุงุณฺฉุฑูพุฑ ุจุง ฺฉุฏ ุฎุทุง ${code} ูุชููู ุดุฏ.`);
    }
    console.log('โณ ุฏุฑ ุงูุชุธุงุฑ ููุจุช ุจุนุฏ (ฑ ุณุงุนุช ุฏฺฏุฑ)...');
  });
}