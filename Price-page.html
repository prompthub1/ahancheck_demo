<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª Ù…Ø­ØµÙˆÙ„Ø§Øª | Ø¢Ù‡Ù† Ú†Ú©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap');
        :root { --dark-green: #012612; --primary-green: #02C671; --bg-white: #F7FAF8; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-white); color: var(--dark-green); margin: 0; padding: 0; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
        .factory-section { background: white; border: 1px solid #E2EADD; border-radius: 18px; margin-bottom: 25px; overflow: hidden; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        .status-up { color: #10b981; font-weight: bold; }
        .status-down { color: #ef4444; font-weight: bold; }
        .price-cell { font-family: 'Vazirmatn', sans-serif; letter-spacing: -0.5px; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 id="pageTitle" class="text-2xl md:text-3xl font-black text-[var(--dark-green)]">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</h1>
                <p class="text-[10px] text-gray-400 mt-2 font-mono opacity-50" id="filePathDisplay"></p>
            </div>
            
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-gray-100 shadow-sm">
                    <span class="text-[10px] font-bold text-gray-500">Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (Û±Û°Ùª)</span>
                    <label class="switch"><input type="checkbox" id="taxToggle" onchange="renderUI()"><span class="slider"></span></label>
                </div>
                <div class="flex bg-gray-200 p-1 rounded-xl shadow-inner">
                    <button onclick="setCurrency('Toman')" id="btnToman" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow text-[var(--primary-green)]">ØªÙˆÙ…Ø§Ù†</button>
                    <button onclick="setCurrency('Rial')" id="btnRial" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500">Ø±ÛŒØ§Ù„</button>
                </div>
                <div class="relative">
                    <input type="text" id="searchInput" onkeyup="filterRows()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„ÛŒØ³Øª..." class="pr-10 pl-4 py-2 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-green)] w-full">
                    <span class="absolute right-3 top-2.5 opacity-20">ğŸ”</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div id="table-container">
            <div class="flex flex-col items-center justify-center py-40 text-gray-300">
                <div class="w-12 h-12 border-4 border-gray-100 border-t-[var(--primary-green)] rounded-full animate-spin mb-4"></div>
                <p class="font-bold">Ø¯Ø± Ø­Ø§Ù„ Ù‡ÙˆØ´Ù…Ù†Ø¯Ø³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª...</p>
            </div>
        </div>
    </div>

    <script>
        let rawData = null;
        let processedGroups = []; // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø´Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø±Ù†Ø¯ ÛŒØ§ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡
        let currency = 'Toman';
        
        const urlParams = new URLSearchParams(window.location.search);
        let productFile = urlParams.get('product') || 'Ù‚ÛŒÙ…Øª-Ù…ÛŒÙ„Ú¯Ø±Ø¯';

        async function loadJson() {
            const container = document.getElementById('table-container');
            const path = `data/${productFile}.json`;
            document.getElementById('filePathDisplay').innerText = `Data Source: /${path}`;

            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                rawData = await response.json();
                
                // ØªÙ†Ø¸ÛŒÙ… Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ù‡
                const cleanTitle = productFile.replace(/-/g, ' ');
                document.getElementById('pageTitle').innerText = cleanTitle;
                
                processData();
                renderUI();
            } catch (e) {
                console.error("Fetch failed:", e);
                container.innerHTML = `
                    <div class="glass-card p-12 text-center">
                        <div class="text-5xl mb-6">âš ï¸</div>
                        <h2 class="text-red-500 font-black text-xl">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h2>
                        <p class="mt-4 text-gray-500 text-sm">ÙØ§ÛŒÙ„ <code class="bg-gray-100 px-2 py-1 rounded">${productFile}.json</code> ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø³Ø§Ø®ØªØ§Ø± Ù†Ø§ØµØ­ÛŒØ­ÛŒ Ø¯Ø§Ø±Ø¯.</p>
                        <button onclick="window.history.back()" class="mt-8 bg-[var(--dark-green)] text-white px-8 py-3 rounded-2xl font-bold shadow-lg">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                    </div>`;
            }
        }

        /**
         * ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù… Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØµÙˆÙ„Ø§Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ù…ÛŒØ§Ù† Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…ØªÙØ±Ù‚Ù‡
         */
        function processData() {
            if (!rawData || !rawData.rows) return;
            
            const headers = rawData.headers;
            const allRows = rawData.rows;
            const validRows = [];
            
            let lastUpdateInfo = rawData.updated_at;

            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø³ØªÙˆÙ† Ù‚ÛŒÙ…Øª Ùˆ Ø¨Ø±Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
            const priceIdx = headers.findIndex(h => h.includes("Ù‚ÛŒÙ…Øª") || h.includes("Ù†Ø±Ø®"));
            const brandIdx = headers.findIndex(h => h.includes("Ø¨Ø±Ù†Ø¯") || h.includes("ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡") || h.includes("Ú©Ø§Ø±Ø®Ø§Ù†Ù‡"));

            allRows.forEach((row, index) => {
                // Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø­Ø§ÙˆÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø³ØªÙ†Ø¯
                const rowString = JSON.stringify(row);
                if (rowString.includes("Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ") || row[priceIdx] === "" || !row[priceIdx]) {
                    return; 
                }

                // Ø³Ø§Ø®Øª Ø´ÛŒØ¡ Ù…Ø­ØµÙˆÙ„
                const product = {
                    values: row,
                    brand: brandIdx !== -1 ? row[brandIdx] : "Ù…ØªÙØ±Ù‚Ù‡",
                    priceRaw: row[priceIdx] ? row[priceIdx].toString().replace(/,/g, '') : "0",
                    change: "0" // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                };

                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ù†ÙˆØ³Ø§Ù† Ø§Ø² Ø±Ø¯ÛŒÙ Ø¨Ø¹Ø¯ÛŒ (Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø±Ø®ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù†ÙˆØ³Ø§Ù† Ø¯Ø± Ø±Ø¯ÛŒÙ Ø²ÛŒØ±ÛŒÙ† Ø§Ø³Øª)
                if (allRows[index + 1]) {
                    const nextRowStr = allRows[index + 1][0] || "";
                    if (nextRowStr.includes("Ù†ÙˆØ³Ø§Ù†Ø§Øª")) {
                        const match = nextRowStr.match(/([+-]?\d+(\.\d+)?%)/);
                        if (match) product.change = match[0];
                    }
                }

                validRows.push(product);
            });

            // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø±Ù†Ø¯
            const groups = {};
            validRows.forEach(item => {
                if (!groups[item.brand]) groups[item.brand] = [];
                groups[item.brand].push(item);
            });

            processedGroups = Object.entries(groups).map(([name, items]) => ({
                title: name,
                headers: headers,
                items: items
            }));
        }

        function setCurrency(c) {
            currency = c;
            document.getElementById('btnToman').className = (c === 'Toman') ? 'px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow text-[var(--primary-green)]' : 'px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500';
            document.getElementById('btnRial').className = (c === 'Rial') ? 'px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow text-[var(--primary-green)]' : 'px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500';
            renderUI();
        }

        function formatPrice(rawVal) {
            let n = parseFloat(rawVal);
            if (isNaN(n) || n === 0) return "-";

            // Û±. Ù…Ø§Ù„ÛŒØ§Øª Û±Û° Ø¯Ø±ØµØ¯ (Ø¨Ø± Ø±ÙˆÛŒ Ù‚ÛŒÙ…Øª ØªÙˆÙ…Ø§Ù† ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø² Ø¬ÛŒØ³ÙˆÙ† Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯)
            if (document.getElementById('taxToggle').checked) {
                n = n * 1.1;
            }

            // Û². ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±ÛŒØ§Ù„ Ø¯Ø± ØµÙˆØ±Øª Ø§Ù†ØªØ®Ø§Ø¨ (Ø¯ÛŒØªØ§ÛŒ Ù¾Ø§ÛŒÙ‡ ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª)
            if (currency === 'Rial') {
                n = n * 10;
            }

            return Math.round(n).toLocaleString('fa-IR');
        }

        function renderUI() {
            const container = document.getElementById('table-container');
            if (processedGroups.length === 0) return;
            
            container.innerHTML = '';

            processedGroups.forEach(group => {
                const section = document.createElement('div');
                section.className = 'factory-section shadow-sm';
                
                let rowsHtml = '';
                group.items.forEach(item => {
                    rowsHtml += `<tr class="hover:bg-green-50/30 border-b border-gray-50 transition-colors">`;
                    
                    group.headers.forEach((h, idx) => {
                        let content = item.values[idx] || "-";
                        let cls = "p-4 text-sm text-right";

                        // Ø§Ú¯Ø± Ø³ØªÙˆÙ† Ù‚ÛŒÙ…Øª Ø§Ø³Øª
                        if (h.includes("Ù‚ÛŒÙ…Øª") || h.includes("Ù†Ø±Ø®")) {
                            content = formatPrice(item.priceRaw);
                            cls += " font-black text-gray-900 price-cell text-base";
                        }
                        
                        // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØ³Ø§Ù† Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ (Ø§Ú¯Ø± Ø³ØªÙˆÙ† Ø§Ø®ØªØµØ§ØµÛŒ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ù‡ Ø³ØªÙˆÙ† Ù‚ÛŒÙ…Øª Ù¾ÛŒÙˆØ³Øª Ú©Ø±Ø¯ ÛŒØ§ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯)
                        rowsHtml += `<td class="${cls}">${content}</td>`;
                    });
                    
                    rowsHtml += `</tr>`;
                });

                section.innerHTML = `
                    <div class="bg-gray-50/50 p-5 flex justify-between items-center border-b border-gray-100">
                        <div class="flex items-center gap-3">
                            <span class="w-1.5 h-6 bg-[var(--primary-green)] rounded-full"></span>
                            <h2 class="font-black text-lg text-[var(--dark-green)]">${group.title}</h2>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400 bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm">
                            ${group.items.length} Ø±Ø¯ÛŒÙ Ú©Ø§Ù„Ø§
                        </span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead>
                                <tr class="text-[11px] text-gray-400 font-bold bg-white border-b border-gray-50">
                                    ${group.headers.map(h => `<th class="p-4 font-black">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function filterRows() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const sections = document.querySelectorAll('.factory-section');
            sections.forEach(s => {
                const text = s.innerText.toLowerCase();
                s.style.display = text.includes(q) ? '' : 'none';
            });
        }

        window.onload = loadJson;
    </script>
</body>
</html>
