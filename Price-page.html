<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª Ù…Ø­ØµÙˆÙ„Ø§Øª | Ø¢Ù‡Ù† Ú†Ú©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap');
        :root { --dark-green: #012612; --primary-green: #02C671; --bg-white: #F7FAF8; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-white); color: var(--dark-green); margin: 0; padding: 0; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
        .factory-section { background: white; border: 1px solid #E2EADD; border-radius: 18px; margin-bottom: 25px; overflow: hidden; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        .status-up { color: #10b981; font-weight: bold; }
        .status-down { color: #ef4444; font-weight: bold; }
        .price-cell { font-family: 'Vazirmatn', sans-serif; letter-spacing: -0.5px; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 id="pageTitle" class="text-2xl md:text-3xl font-black text-[var(--dark-green)]">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</h1>
                <p class="text-[10px] text-gray-400 mt-2 font-mono opacity-50" id="filePathDisplay"></p>
            </div>
            
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-gray-100 shadow-sm">
                    <span class="text-[10px] font-bold text-gray-500">Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (Û±Û°Ùª)</span>
                    <label class="switch"><input type="checkbox" id="taxToggle" onchange="renderData()"><span class="slider"></span></label>
                </div>
                <div class="flex bg-gray-200 p-1 rounded-xl shadow-inner">
                    <button onclick="setCurrency('Toman')" id="btnToman" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow text-[var(--primary-green)]">ØªÙˆÙ…Ø§Ù†</button>
                    <button onclick="setCurrency('Rial')" id="btnRial" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500">Ø±ÛŒØ§Ù„</button>
                </div>
                <div class="relative">
                    <input type="text" id="searchInput" onkeyup="filterRows()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„ÛŒØ³Øª..." class="pr-10 pl-4 py-2 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-green)] w-full">
                    <span class="absolute right-3 top-2.5 opacity-20">ğŸ”</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div id="table-container">
            <div class="flex flex-col items-center justify-center py-40 text-gray-300">
                <div class="w-12 h-12 border-4 border-gray-100 border-t-[var(--primary-green)] rounded-full animate-spin mb-4"></div>
                <p class="font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§...</p>
            </div>
        </div>
    </div>

    <script>
        let dbData = null;
        let currency = 'Toman';
        
        const urlParams = new URLSearchParams(window.location.search);
        let product = urlParams.get('product') || 'Ù‚ÛŒÙ…Øª-Ù…ÛŒÙ„Ú¯Ø±Ø¯';

        async function loadJson() {
            const container = document.getElementById('table-container');
            // Ø¢Ø¯Ø±Ø³â€ŒØ¯Ù‡ÛŒ Ù†Ø³Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯ Ø¯Ø± GitHub Pages Ùˆ Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
            const path = `data/${product}.json`;
            document.getElementById('filePathDisplay').innerText = `Source: /${path}`;

            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                dbData = await response.json();
                
                // Ù…Ø·Ø§Ø¨Ù‚ Ø§Ø³Ú©ÛŒÙ…Ø§: dbData.product.title
                document.getElementById('pageTitle').innerText = (dbData.product && dbData.product.title) ? dbData.product.title : product.replace(/-/g, ' ');
                renderData();
            } catch (e) {
                console.error("Fetch failed:", e);
                container.innerHTML = `
                    <div class="glass-card p-12 text-center">
                        <div class="text-5xl mb-6">âš ï¸</div>
                        <h2 class="text-red-500 font-black text-xl">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯</h2>
                        <p class="mt-4 text-gray-500 text-sm">Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ ÙØ§ÛŒÙ„ÛŒ Ø¨Ø§ Ù†Ø§Ù… <code class="bg-gray-100 px-2 py-1 rounded">${product}.json</code> Ø¯Ø± Ù¾ÙˆØ´Ù‡ Ø¯ÛŒØªØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
                        <button onclick="window.history.back()" class="mt-8 bg-[var(--dark-green)] text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:opacity-90 transition-all">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</button>
                    </div>`;
            }
        }

        function setCurrency(c) {
            currency = c;
            const isToman = c === 'Toman';
            document.getElementById('btnToman').className = isToman ? 'px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow text-[var(--primary-green)]' : 'px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500';
            document.getElementById('btnRial').className = !isToman ? 'px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow text-[var(--primary-green)]' : 'px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500';
            renderData();
        }

        /**
         * Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ Ø±ÛŒØ§Ù„
         */
        function processPrice(val, fieldType) {
            if (val === undefined || val === null || val === "" || val === "-") return "-";
            
            // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø§Ø³Øª
            if (fieldType === 'price') {
                let n = parseFloat(val.toString().replace(/,/g, ''));
                if (isNaN(n)) return val;

                // Û±. Ø§Ø¹Ù…Ø§Ù„ Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø±ÙˆÛŒ Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ (Ø±ÛŒØ§Ù„)
                if (document.getElementById('taxToggle').checked) {
                    n = n * 1.1;
                }

                // Û². ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯ (Ù¾Ø§ÛŒÙ‡ Ø¯ÛŒØªØ§ Ø±ÛŒØ§Ù„ Ø§Ø³Øª)
                if (currency === 'Toman') {
                    n = n / 10;
                }

                return Math.round(n).toLocaleString('fa-IR');
            }
            
            // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø±ØµØ¯ÛŒ
            if (fieldType === 'change') {
                const n = parseFloat(val);
                if (isNaN(n) || n === 0) return "-";
                return (n > 0 ? "+" : "") + n.toLocaleString('fa-IR') + "Ùª";
            }

            return val.toLocaleString('fa-IR');
        }

        function renderData() {
            if (!dbData || !dbData.tables) return;
            const container = document.getElementById('table-container');
            container.innerHTML = '';

            dbData.tables.forEach(table => {
                const section = document.createElement('div');
                section.className = 'factory-section shadow-sm border border-gray-100';
                
                let rowsHtml = '';
                table.rows.forEach(row => {
                    rowsHtml += `<tr class="hover:bg-green-50/30 border-b border-gray-50 transition-colors">`;
                    
                    table.headers.forEach(h => {
                        let value = "-";
                        let fieldType = "text";

                        // Ù…Ù¾ÛŒÙ†Ú¯ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø³Ú©ÛŒÙ…Ø§
                        if (h.includes("Ù‚ÛŒÙ…Øª") || h.includes("Ù†Ø±Ø®")) {
                            value = row.price;
                            fieldType = "price";
                        } else if (h.includes("ØªØºÛŒÛŒØ±") || h.includes("Ù†ÙˆØ³Ø§Ù†")) {
                            value = row.change_percent;
                            fieldType = "change";
                        } else if (h.includes("ØªØ§Ø±ÛŒØ®") || h.includes("Ø²Ù…Ø§Ù†")) {
                            value = row.date;
                        } else {
                            // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø­ØµÙˆÙ„ (specs)
                            value = row.specs ? (row.specs[h] || "-") : "-";
                        }

                        const displayVal = processPrice(value, fieldType);
                        let cls = "p-4 text-sm text-right";
                        
                        if (fieldType === "price") cls += " font-black text-gray-900 price-cell text-base";
                        if (fieldType === "change") {
                            const num = parseFloat(value);
                            if (num > 0) cls += " status-up";
                            else if (num < 0) cls += " status-down";
                        }
                        
                        rowsHtml += `<td class="${cls}">${displayVal}</td>`;
                    });
                    rowsHtml += `</tr>`;
                });

                section.innerHTML = `
                    <div class="bg-gray-50/50 p-5 flex justify-between items-center border-b border-gray-100">
                        <div class="flex items-center gap-3">
                            <span class="w-1.5 h-6 bg-[var(--primary-green)] rounded-full"></span>
                            <h2 class="font-black text-lg text-[var(--dark-green)]">${table.section_title}</h2>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400 bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm">
                            Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${dbData.last_update || 'Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ'}
                        </span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead>
                                <tr class="text-[11px] text-gray-400 font-bold bg-white border-b border-gray-50">
                                    ${table.headers.map(h => `<th class="p-4 font-black">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function filterRows() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            // ÙÙ‚Ø· Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¨Ø¯Ù†Ù‡ Ø¬Ø¯Ø§ÙˆÙ„ (tbody) Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø®ÙÛŒ Ø´Ø¯Ù† Ù‡Ø¯Ø±Ù‡Ø§
            const rows = document.querySelectorAll('#table-container tbody tr');
            rows.forEach(tr => {
                const text = tr.innerText.toLowerCase();
                tr.style.display = text.includes(q) ? '' : 'none';
            });
        }

        window.onload = loadJson;
    </script>
</body>
</html>
