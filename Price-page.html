<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لیست قیمت محصولات | آهن چک</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap');
        :root { --dark-green: #012612; --primary-green: #02C671; --bg-white: #F7FAF8; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-white); color: var(--dark-green); margin: 0; padding: 0; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
        .factory-section { background: white; border: 1px solid #E2EADD; border-radius: 18px; margin-bottom: 25px; overflow: hidden; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        .status-up { color: #10b981; font-weight: bold; }
        .status-down { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 id="pageTitle" class="text-2xl md:text-3xl font-black text-[var(--dark-green)]">در حال بارگذاری...</h1>
                <p class="text-xs text-gray-400 mt-2 italic" id="filePathDisplay"></p>
            </div>
            
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl border border-gray-100 shadow-sm">
                    <span class="text-[10px] font-bold text-gray-500">ارزش افزوده</span>
                    <label class="switch"><input type="checkbox" id="taxToggle" onchange="renderData()"><span class="slider"></span></label>
                </div>
                <div class="flex bg-gray-200 p-1 rounded-xl">
                    <button onclick="setCurrency('Toman')" id="btnToman" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-white shadow text-[var(--primary-green)]">تومان</button>
                    <button onclick="setCurrency('Rial')" id="btnRial" class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-gray-500">ریال</button>
                </div>
                <input type="text" id="searchInput" onkeyup="filterRows()" placeholder="جستجو..." class="px-4 py-2 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-green)]">
            </div>
        </div>

        <!-- Content -->
        <div id="table-container">
            <div class="text-center py-20 text-gray-400">در حال فراخوانی فایل JSON...</div>
        </div>
    </div>

    <script>
        let dbData = null;
        let currency = 'Toman';
        
        // حل مشکل کاراکترهای فارسی در نام فایل
        const urlParams = new URLSearchParams(window.location.search);
        let product = urlParams.get('product') || 'قیمت-میلگرد';

        async function loadJson() {
            const container = document.getElementById('table-container');
            // مسیر دقیق پوشه دیتا
            const path = `data/${product}.json`;
            document.getElementById('filePathDisplay').innerText = `Source: ${path}`;

            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                dbData = await response.json();
                
                document.getElementById('pageTitle').innerText = dbData.title || product.replace(/-/g, ' ');
                renderData();
            } catch (e) {
                container.innerHTML = `<div class="glass-card p-10 text-center"><h2 class="text-red-500 font-bold text-xl">خطای ۴۰۴: فایل یافت نشد</h2><p class="mt-4 text-gray-500 text-sm italic">مسیر بررسی شده: ${path}</p><button onclick="location.reload()" class="mt-6 bg-gray-800 text-white px-6 py-2 rounded-xl">تلاش مجدد</button></div>`;
            }
        }

        function setCurrency(c) {
            currency = c;
            document.getElementById('btnToman').className = c === 'Toman' ? 'px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow text-[var(--primary-green)]' : 'px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500';
            document.getElementById('btnRial').className = c === 'Rial' ? 'px-4 py-1.5 rounded-lg text-xs font-bold bg-white shadow text-[var(--primary-green)]' : 'px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500';
            renderData();
        }

        function processPrice(val, isPriceCol) {
            if (!val || val === "-") return "-";
            if (!isPriceCol) return val;

            let n = parseFloat(val.toString().replace(/,/g, ''));
            if (isNaN(n)) return val;

            if (document.getElementById('taxToggle').checked) n *= 1.1;
            if (currency === 'Rial') n *= 10;

            return Math.round(n).toLocaleString('fa-IR');
        }

        function renderData() {
            if (!dbData || !dbData.tables) return;
            const container = document.getElementById('table-container');
            container.innerHTML = '';

            dbData.tables.forEach(table => {
                const card = document.createElement('div');
                card.className = 'factory-section shadow-sm';
                
                let rowsHtml = '';
                table.rows.forEach(row => {
                    rowsHtml += `<tr class="hover:bg-gray-50 border-b border-gray-50">`;
                    table.headers.forEach(h => {
                        const isPrice = h.includes("قیمت") || h.includes("نرخ");
                        const displayVal = processPrice(row[h], isPrice);
                        let cls = "p-4 text-sm";
                        if (isPrice) cls += " font-bold text-gray-800";
                        if (h.includes("تغییر")) {
                            if (row[h].toString().includes("-")) cls += " status-down";
                            else if (row[h] !== "0" && row[h] !== "-") cls += " status-up";
                        }
                        rowsHtml += `<td class="${cls}">${displayVal}</td>`;
                    });
                    rowsHtml += `</tr>`;
                });

                card.innerHTML = `
                    <div class="bg-gray-50 p-4 font-bold text-gray-700 border-b border-gray-100">${table.section_title}</div>
                    <div class="overflow-x-auto"><table class="w-full text-right">
                        <thead><tr class="text-[10px] text-gray-400 uppercase bg-white">
                            ${table.headers.map(h => `<th class="p-4 font-medium">${h}</th>`).join('')}
                        </tr></thead>
                        <tbody>${rowsHtml}</tbody>
                    </table></div>
                `;
                container.appendChild(card);
            });
        }

        function filterRows() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('tr').forEach((tr, i) => {
                if (i === 0) return;
                tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        window.onload = loadJson;
    </script>
</body>
</html>
