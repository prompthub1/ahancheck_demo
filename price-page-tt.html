<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لیست قیمت روز | آهن چک</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/prompthub1/ahancheck_demo/refs/heads/main/assets/favicon.ico">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap');
        :root { 
            --primary-green: #02C671; 
            --dark-green: #012612; 
            --header-green: #013a1b; /* رنگ سبز تیره سازمانی برای هدر جداول */
            --bg-soft: #f8fafc; 
            --zebra-green: #f1f7f4; 
        }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-soft); 
            color: var(--dark-green); 
            overflow-x: hidden; 
        }

        /* Bordered Boxes - مشخص‌تر شده */
        .glass-card {
            background: #ffffff;
            border: 1px solid #cbd5e1; /* تیره تر شده برای وضوح بیشتر */
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .factory-section {
            background: white;
            border-radius: 16px;
            margin-bottom: 2.5rem;
            overflow: hidden;
            border: 1.5px solid #b7bfc9; /* خط طوسی مشخص‌تر دور باکس‌ها */
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        tbody tr:nth-child(even) { background-color: var(--zebra-green); }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #94a3b8; transition: .3s; border-radius: 20px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; 
            background-color: white; transition: .3s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--primary-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Typography */
        .price-cell { font-family: 'Vazirmatn', sans-serif; letter-spacing: -0.5px; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .call-btn {
            background: var(--dark-green);
            color: white;
            padding: 18px;
            border-radius: 20px;
            text-align: center;
            font-weight: 900;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .logo-box img { max-height: 52px; width: auto; }
        
        /* Table Sticky Header Customization */
        th {
            background-color: var(--header-green) !important;
            color: #ffffff !important;
            border-left: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="pb-20">

    <!-- Header Section -->
    <header class="bg-white sticky top-0 z-50 border-b-2 border-gray-100 shadow-md">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-6 h-full">
                <a href="index.html" class="logo-box block transform transition hover:scale-105">
                    <img src="assets/logo.png" alt="آهن چک" onerror="this.src='https://raw.githubusercontent.com/prompthub1/ahancheck_demo/refs/heads/main/assets/logo.png'">
                </a>
                <h1 id="pageTitle" class="font-black text-base md:text-2xl text-slate-900 border-r-2 pr-5 border-gray-200 truncate max-w-[180px] md:max-w-none">بارگذاری...</h1>
            </div>
            
            <a href="index.html" class="text-sm font-black text-slate-600 hover:text-[var(--primary-green)] flex items-center gap-2 transition-all group">
                <span class="hidden md:inline">برگشت به خانه</span>
                <svg class="w-6 h-6 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 md:px-6 py-10">
        
        <!-- Search & Controls Box -->
        <div class="glass-card p-6 mb-12">
            <div class="flex flex-col lg:flex-row gap-6 items-stretch lg:items-center">
                
                <!-- Search Input -->
                <div class="relative flex-grow order-1 lg:order-2">
                    <input type="text" id="searchInput" onkeyup="filterRows()" placeholder="جستجوی در میان کالاها، برندها یا سایز..." 
                           class="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl px-14 py-5 focus:ring-4 focus:ring-[var(--primary-green)]/20 focus:border-[var(--primary-green)] outline-none text-lg font-bold transition-all shadow-inner text-right">
                    <svg class="w-7 h-7 absolute right-5 top-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2.5" stroke-linecap="round"/></svg>
                </div>

                <!-- Controls -->
                <div class="flex flex-wrap items-center gap-4 order-2 lg:order-1">
                    <!-- Tax Toggle -->
                    <div class="flex-1 lg:flex-none flex items-center gap-5 bg-slate-50 px-6 py-4 rounded-2xl border-2 border-gray-200 min-w-[210px]">
                        <span class="text-sm md:text-base font-black text-slate-800 text-right w-full">ارزش افزوده (%۱۰)</span>
                        <label class="switch">
                            <input type="checkbox" id="taxToggle" onchange="renderUI()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- Currency Toggle -->
                    <div class="flex bg-slate-200 p-2 rounded-2xl w-40 md:w-48 shadow-inner h-[62px] items-center border border-gray-300">
                        <button onclick="setCurrency('Toman')" id="btnToman" class="flex-1 h-full rounded-xl text-sm md:text-base font-black transition-all bg-[var(--primary-green)] text-white shadow-lg">تومان</button>
                        <button onclick="setCurrency('Rial')" id="btnRial" class="flex-1 h-full rounded-xl text-sm md:text-base font-black transition-all text-slate-600 hover:text-slate-900">ریال</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Content Area -->
        <div id="table-container">
            <!-- Loading Skeletons -->
            <div class="space-y-8">
                <div class="h-72 w-full bg-gray-100 rounded-2xl animate-pulse border-2 border-gray-200"></div>
                <div class="h-72 w-full bg-gray-100 rounded-2xl animate-pulse border-2 border-gray-200"></div>
            </div>
        </div>
    </main>

    <script>
        let rawData = null;
        let currentCurrency = 'Toman';

        async function loadJson() {
            const params = new URLSearchParams(window.location.search);
            const category = params.get('cat') || 'تیرآهن';
            document.getElementById('pageTitle').innerText = `قیمت روز ${category}`;

            try {
                const response = await fetch(`data/${category}.json`);
                if (!response.ok) throw new Error('فایل یافت نشد');
                rawData = await response.json();
                renderUI();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('table-container').innerHTML = `
                    <div class="bg-red-50 text-red-600 p-8 rounded-3xl text-center border border-red-100">
                        <p class="font-bold text-xl mb-2">خطا در بارگذاری داده‌ها</p>
                        <p>متاسفانه اطلاعات قیمت برای این دسته‌بندی فعلاً در دسترس نیست.</p>
                        <a href="index.html" class="inline-block mt-4 text-sm underline">بازگشت به صفحه اصلی</a>
                    </div>
                `;
            }
        }

        function setCurrency(type) {
            currentCurrency = type;
            document.getElementById('btnToman').className = type === 'Toman' 
                ? 'flex-1 h-full rounded-xl text-sm md:text-base font-black transition-all bg-[var(--primary-green)] text-white shadow-lg' 
                : 'flex-1 h-full rounded-xl text-sm md:text-base font-black transition-all text-slate-600 hover:text-slate-900';
            document.getElementById('btnRial').className = type === 'Rial' 
                ? 'flex-1 h-full rounded-xl text-sm md:text-base font-black transition-all bg-[var(--primary-green)] text-white shadow-lg' 
                : 'flex-1 h-full rounded-xl text-sm md:text-base font-black transition-all text-slate-600 hover:text-slate-900';
            renderUI();
        }

        function formatPrice(num) {
            if (!num) return 'تماس بگیرید';
            let price = num;
            
            // اعمال ارزش افزوده ۱۰٪ در صورت فعال بودن
            if (document.getElementById('taxToggle').checked) {
                price = price * 1.1;
            }

            // تبدیل به ریال در صورت انتخاب
            if (currentCurrency === 'Rial') {
                price = price * 10;
            }

            return Math.round(price).toLocaleString('fa-IR');
        }

        function renderUI() {
            if (!rawData) return;
            const container = document.getElementById('table-container');
            container.innerHTML = '';

            const headers = rawData.headersss || [];
            const groupedData = {};

            rawData.dataaa.forEach(item => {
                // نادیده گرفتن ردیف‌های متنی (بروزرسانی/نوسان)
                const isStatusRow = Object.values(item).some(v => typeof v === 'string' && (v.includes('بروز رسانی') || v.includes('نوسانات')));
                if (isStatusRow || (!item.price_strrr && !item.col_0 && !item.titleee)) return;

                const groupName = item.group_infooo?.category_nameee || 'سایر';
                if (!groupedData[groupName]) groupedData[groupName] = [];
                groupedData[groupName].push(item);
            });

            Object.keys(groupedData).forEach(groupName => {
                const items = groupedData[groupName];
                const section = document.createElement('div');
                section.className = 'factory-section';

                let rowsHtml = '';
                items.forEach(row => {
                    let cellsHtml = '';
                    
                    for (let i = 0; i < headers.length; i++) {
                        let content = '-';
                        const isLastColumn = (i === headers.length - 1);

                        if (isLastColumn) {
                            content = formatPrice(row.price_nummm);
                            cellsHtml += `<td class="px-4 md:px-6 py-4 text-sm md:text-lg font-black text-slate-900 text-left ltr price-cell">${content}</td>`;
                        } else {
                            // منطق هوشمند استخراج دیتا از فیلدها
                            content = row[`col_${i}`] || row['titleee'] || row['sizeee'] || row['unittt'] || '-';
                            // اصلاح برای حالاتی که فیلدهای خاص پر شده‌اند
                            if (i === 0 && row['titleee']) content = row['titleee'];
                            if (i === 1 && row['sizeee']) content = row['sizeee'];
                            
                            cellsHtml += `<td class="px-4 md:px-6 py-4 text-sm md:text-base font-medium text-slate-700 text-right">${content}</td>`;
                        }
                    }
                    rowsHtml += `<tr class="border-b border-gray-50 hover:bg-emerald-50/30 transition-colors">${cellsHtml}</tr>`;
                });

                // تغییر هدر ستون آخر بر اساس واحد پول
                const modifiedHeaders = [...headers];
                modifiedHeaders[headers.length-1] = `قیمت (${currentCurrency === 'Toman' ? 'تومان' : 'ریال'})`;

                section.innerHTML = `
                    <div class="bg-slate-50 px-6 py-5 border-b border-gray-200 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-[var(--primary-green)] rounded-full shadow-[0_0_10px_rgba(2,198,113,0.3)]"></div>
                            <h2 class="font-black text-xl md:text-2xl text-slate-950">${groupName}</h2>
                        </div>
                        <span class="hidden md:block text-xs font-bold text-slate-400 bg-white px-4 py-2 rounded-full border border-gray-200 shadow-sm uppercase tracking-tighter">Live Update</span>
                    </div>
                    <div class="overflow-x-auto hide-scrollbar">
                        <table class="w-full text-right border-collapse">
                            <thead>
                                <tr>
                                    ${modifiedHeaders.map(h => `<th class="px-4 md:px-6 py-5 whitespace-nowrap text-right text-sm font-black">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function filterRows() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.factory-section').forEach(s => {
                s.style.display = s.innerText.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        window.onload = loadJson;
    </script>
</body>
</html>
