<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لیست قیمت روز | آهن چک</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/prompthub1/ahancheck_demo/refs/heads/main/assets/favicon.ico">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700;900&display=swap');
        :root { 
            --primary-green: #02C671; 
            --dark-green: #012612; 
            --header-green: #013a1b;
            --bg-soft: #f8fafc; 
            --zebra-green: #f1f7f4; 
        }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-soft); 
            color: var(--dark-green); 
            overflow-x: hidden; 
        }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(2, 198, 113, 0.1); }
        .factory-section { border: 1px solid #e2e8f0; margin-bottom: 2rem; border-radius: 1.5rem; overflow: hidden; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        thead tr { background-color: var(--header-green); color: white; }
        tbody tr:nth-child(even) { background-color: var(--zebra-green); }
        tbody tr:hover { background-color: #e8f5ee; transition: all 0.2s; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .price-up { color: #059669; font-weight: bold; }
        .price-down { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body class="pb-20">

    <!-- Header Section -->
    <header class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="p-2 hover:bg-gray-50 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                </a>
                <h1 id="pageTitle" class="text-xl md:text-2xl font-black text-slate-900">در حال بارگذاری...</h1>
            </div>
            <img src="https://raw.githubusercontent.com/prompthub1/ahancheck_demo/refs/heads/main/assets/logo.png" class="h-10 md:h-12 object-contain" alt="آهن چک">
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 mt-8">
        <!-- Search & Filter -->
        <div class="mb-8 flex flex-col md:flex-row gap-4">
            <div class="relative flex-1">
                <input type="text" id="searchInput" onkeyup="filterRows()" placeholder="جستجو در بین برندها و مشخصات..." 
                       class="w-full pl-12 pr-6 py-4 rounded-2xl border-2 border-gray-100 focus:border-[var(--primary-green)] outline-none transition-all shadow-sm text-lg">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
        </div>

        <div id="tablesContainer">
            <!-- Tables will be injected here -->
            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--primary-green)] mb-4"></div>
                <p>در حال دریافت آخرین قیمت‌ها از بازار...</p>
            </div>
        </div>
    </main>

    <script>
        async function loadJson() {
            const params = new URLSearchParams(window.location.search);
            const category = params.get('cat') || 'تیرآهن';
            document.getElementById('pageTitle').innerText = `قیمت روز ${category}`;

            try {
                const response = await fetch(`data/${category}.json`);
                if (!response.ok) throw new Error('فایل یافت نشد');
                const result = await response.json();
                renderTables(result);
            } catch (error) {
                document.getElementById('tablesContainer').innerHTML = `
                    <div class="bg-red-50 text-red-600 p-8 rounded-3xl text-center border border-red-100">
                        <p class="font-bold text-xl mb-2">خطا در بارگذاری داده‌ها</p>
                        <p>متاسفانه اطلاعات قیمت برای این دسته‌بندی فعلاً در دسترس نیست.</p>
                        <a href="index.html" class="inline-block mt-4 text-sm underline">بازگشت به صفحه اصلی</a>
                    </div>
                `;
            }
        }

        function renderTables(json) {
            const container = document.getElementById('tablesContainer');
            container.innerHTML = '';

            if (!json.dataaa || json.dataaa.length === 0) return;

            const headers = json.headersss || [];

            // Grouping data by category_nameee
            const groups = {};
            json.dataaa.forEach(item => {
                // Ignore status/update rows (based on presence of date-like strings or "بروز رسانی")
                const values = Object.values(item).join(' ');
                if (values.includes('بروز رسانی') || values.includes('نوسانات')) return;
                
                // Also ignore rows that are mostly empty (only status info)
                if (!item.price_strrr && !item.col_0 && !item.titleee) return;

                const catName = item.group_infooo?.category_nameee || 'سایر';
                if (!groups[catName]) groups[catName] = [];
                groups[catName].push(item);
            });

            Object.keys(groups).forEach(groupName => {
                const rows = groups[groupName];
                const section = document.createElement('div');
                section.className = 'factory-section';

                let rowsHtml = '';
                rows.forEach(row => {
                    let cells = [];
                    
                    // Logic to map the headers to the data fields dynamically
                    // We check common keys in order of likelihood
                    const dataKeys = ['titleee', 'sizeee', 'col_2', 'unittt', 'col_4', 'col_5', 'col_6'];
                    
                    for(let i=0; i < headers.length - 1; i++) {
                        // Prefer col_X if available, otherwise fallback to semantic keys
                        let val = row[`col_${i}`];
                        
                        if (val === undefined || val === null) {
                            // Map specific semantic keys based on header index if col_X is missing
                            if (i === 0) val = row['titleee'] || row['sizeee'] || row['col_0'];
                            else if (i === 1) val = row['sizeee'] || row['col_1'];
                            else val = row[dataKeys[i]] || '-';
                        }
                        
                        cells.push(`<td class="px-4 md:px-6 py-4 text-sm md:text-base font-medium text-slate-700">${val || '-'}</td>`);
                    }

                    // Price column (Always the last one)
                    const price = row.price_strrr || 'تماس بگیرید';
                    cells.push(`<td class="px-4 md:px-6 py-4 text-sm md:text-lg font-black text-slate-900 text-left ltr">${price}</td>`);

                    rowsHtml += `<tr class="border-b border-gray-50">${cells.join('')}</tr>`;
                });

                section.innerHTML = `
                    <div class="bg-slate-50 px-6 py-5 border-b border-gray-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-[var(--primary-green)] rounded-full shadow-[0_0_10px_rgba(2,198,113,0.3)]"></div>
                            <h2 class="font-black text-xl md:text-2xl text-slate-950">${groupName}</h2>
                        </div>
                        <span class="hidden md:block text-xs font-bold text-slate-400 bg-white px-4 py-2 rounded-full border border-gray-100 shadow-sm uppercase tracking-tighter">Live Update</span>
                    </div>
                    <div class="overflow-x-auto hide-scrollbar">
                        <table class="w-full text-right border-collapse">
                            <thead>
                                <tr class="text-sm md:text-base font-black">
                                    ${headers.map(h => `<th class="px-4 md:px-6 py-6 whitespace-nowrap">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function filterRows() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.factory-section').forEach(s => {
                const match = s.innerText.toLowerCase().includes(q);
                s.style.display = match ? '' : 'none';
            });
        }

        window.onload = loadJson;
    </script>
</body>
</html>
